version: 2.1
workflows:
  test:
    jobs:
      - test:
          matrix:
            parameters:
              keycloak-version:
                - '11.0.1'
                - '10.0.2'
                - '9.0.3'
  release:
    jobs:
      - test:
          keycloak-version: '11.0.1'
          filters:
            tags:
              only: /\d+\.\d+\.\d+(-rc.\d+)?/
            branches:
              ignore: /.*/
      - build-and-release:
          requires:
            - test
          filters:
            tags:
              only: /\d+\.\d+\.\d+(-rc.\d+)?/
            branches:
              ignore: /.*/

defaults:
  go_image: &go_image
    - image: circleci/golang:1.13.5

jobs:
  test:
    parameters:
      keycloak-version:
        type: string
    docker:
      - <<: *go_image
      - image: jboss/keycloak:<< parameters.keycloak-version >>
        command: ["-b", "0.0.0.0", "-Dkeycloak.profile.feature.upload_scripts=enabled"]
        environment:
          DB_VENDOR: H2
          KEYCLOAK_LOGLEVEL: DEBUG
          KEYCLOAK_USER: keycloak
          KEYCLOAK_PASSWORD: password

    working_directory: /go/src/github.com/charlesderek/terraform-w-keycloak
    steps:
      - checkout
      - restore_cache:
          keys:
            - go-cache-{{ checksum "go.sum" }}
      - run: go mod download
      - run:
          name: Install go-junit-report
          command: |
            go get github.com/jstemmer/go-junit-report
            mkdir $TEST_RESULTS
      - save_cache:
          key: go-cache-{{ checksum "go.sum" }}
          paths:
            - /go/pkg
      - run:
          name: Install Terraform
          command: |
            curl -LO https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip
            unzip terraform_${TF_VERSION}_linux_amd64.zip
            sudo mv terraform ${TF_ACC_TERRAFORM_PATH}
            which terraform
            terraform version
      - run:
          name: Run Tests
          command: |
            ./scripts/wait-for-local-keycloak.sh
            ./scripts/create-terraform-client.sh
            trap "go-junit-report <${TEST_RESULTS}/go-test.out > ${TEST_RESULTS}/go-test-report.xml" EXIT
            make testacc | tee ${TEST_RESULTS}/go-test.out
          no_output_timeout: 20m
      - store_test_results:
          path: /tmp/test-results
    environment:
      KEYCLOAK_CLIENT_ID: "terraform"
      KEYCLOAK_CLIENT_SECRET: "d0e0f95-0f42-4a63-9b1f-94274655669e"
      KEYCLOAK_CLIENT_TIMEOUT: "5"
      KEYCLOAK_URL: "http://localhost:8080"
      KEYCLOAK_REALM: "master"
      KEYCLOAK_TEST_PASSWORD_GRANT: "true"
      KEYCLOAK_VERSION: "<< parameters.keycloak-version >>"
      TEST_RESULTS: /tmp/test-results
      CHECKPOINT_DISABLE: "1"
      TF_ACC_TERRAFORM_PATH: "/usr/local/bin/terraform"
      TF_VERSION: "0.13.0"

  build-and-release:
    docker:
      - <<: *go_image
    working_directory: /go/src/github.com/charlesderek/terraform-w-keycloak
    steps:
      - checkout
      - add_ssh_keys:
          fingerprints:
            - "27:1c:fb:ea:7d:89:93:bb:13:54:5b:3f:b7:cc:1b:09"
      - run: go mod download
      - run:
          command: |
            ./scripts/build-release.sh
            ./scripts/publish-release.sh

